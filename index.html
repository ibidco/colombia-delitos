<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Delitos en Colombia â€” Datos Abiertos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0b0f1a;
      --card:      #141c2e;
      --border:    #1e2d4a;
      --yellow:    #f5c842;
      --red:       #e03c31;
      --accent:    #4f9cf9;
      --text:      #e8ecf4;
      --muted:     #7a8ba8;
      --font-head: 'Playfair Display', Georgia, serif;
      --font-body: 'Source Serif 4', Georgia, serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      min-height: 100vh;
    }

    body::before {
      content: ''; position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 0;
    }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      position: relative;
      padding: 48px 32px 32px;
      border-bottom: 1px solid var(--border);
    }

    .flag-stripe {
      position: absolute; top: 0; left: 0; right: 0; height: 5px;
      background: linear-gradient(90deg,
        #f5c842 0% 25%, #003087 25% 50%,
        #e03c31 50% 75%, #f5c842 75% 100%);
    }

    .header-inner {
      max-width: 1600px; margin: 0 auto;
      display: flex; align-items: flex-end;
      justify-content: space-between; gap: 20px; flex-wrap: wrap;
    }

    h1 {
      font-family: var(--font-head);
      font-size: clamp(1.8rem, 4vw, 3.6rem);
      font-weight: 900; letter-spacing: -0.025em; line-height: 1.0;
    }
    h1 em { color: var(--yellow); font-style: normal; }

    .subtitle {
      margin-top: 8px; font-size: 0.9rem;
      color: var(--muted); font-weight: 300; font-style: italic;
    }

    .header-right {
      display: flex; flex-direction: column; align-items: flex-end; gap: 8px;
    }

    .btn-refresh {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--yellow); color: #0a0d17; border: none;
      padding: 10px 20px; font-family: var(--font-mono);
      font-size: 0.72rem; font-weight: 600; letter-spacing: 0.1em;
      text-transform: uppercase; cursor: pointer;
      transition: opacity .15s, transform .15s;
      white-space: nowrap;
    }
    .btn-refresh:hover  { opacity: .85; transform: translateY(-1px); }
    .btn-refresh:active { transform: translateY(0); }
    .btn-refresh:disabled { opacity: .4; cursor: not-allowed; transform: none; }
    .btn-refresh svg { width: 13px; height: 13px; flex-shrink: 0; }
    .btn-refresh.spinning svg { animation: spin .7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Oculto por defecto â€” solo visible en modo admin */
    #btn-refresh { display: none; }

    .last-updated {
      font-family: var(--font-mono); font-size: 0.65rem;
      color: var(--muted); text-align: right;
    }

    /* â”€â”€ STATUS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #status-bar {
      max-width: 1600px; margin: 0 auto;
      padding: 12px 32px;
      display: flex; align-items: center; gap: 10px;
      font-family: var(--font-mono); font-size: 0.72rem; color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    .dot {
      width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
      background: var(--muted);
    }
    .dot.loading { background: var(--yellow); animation: blink 1s ease-in-out infinite; }
    .dot.ok      { background: #3ddc84; }
    .dot.error   { background: var(--red); }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }

    /* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main {
      max-width: 1600px; margin: 0 auto;
      padding: 28px 32px 80px;
    }

    /* â”€â”€ RESUMEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #summary {
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(130px,1fr));
      gap: 1px; background: var(--border);
      border: 1px solid var(--border); margin-bottom: 32px;
    }
    .summary-cell { background: var(--card); padding: 16px 20px; }
    .summary-cell .num {
      font-family: var(--font-mono); font-size: 1.5rem;
      font-weight: 600; color: var(--yellow);
    }
    .summary-cell .lbl {
      margin-top: 3px; font-size: 0.65rem; color: var(--muted);
      text-transform: uppercase; letter-spacing: 0.07em;
    }

    /* â”€â”€ SECCIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-title {
      display: flex; align-items: center; gap: 14px; margin-bottom: 20px;
    }
    .section-title h2 {
      font-family: var(--font-mono); font-size: 0.65rem; font-weight: 600;
      color: var(--muted); text-transform: uppercase;
      letter-spacing: 0.15em; white-space: nowrap;
    }
    .section-title hr { flex: 1; border: none; border-top: 1px solid var(--border); }

    /* â”€â”€ GRID: responsive 1-4 columnas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #grid {
      display: grid;
      gap: 12px;
      /* Por defecto en pantallas pequeÃ±as: 1 columna */
      grid-template-columns: 1fr;
    }

    /* â‰¥ 480px â†’ 2 columnas */
    @media (min-width: 480px) {
      #grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* â‰¥ 860px â†’ 3 columnas */
    @media (min-width: 860px) {
      #grid { grid-template-columns: repeat(3, 1fr); }
    }

    /* â‰¥ 1180px â†’ 4 columnas (mÃ¡ximo) */
    @media (min-width: 1180px) {
      #grid { grid-template-columns: repeat(4, 1fr); }
    }

    /* â”€â”€ TARJETA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 14px 14px 10px;
      position: relative;
      animation: up .35s ease both;
      transition: border-color .2s, transform .2s;
    }
    .card:hover { border-color: #335580; transform: translateY(-2px); }
    @keyframes up {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .card-rank {
      position: absolute; top: 9px; right: 10px;
      font-family: var(--font-mono); font-size: 0.55rem; color: var(--border);
    }

    .card-name {
      font-size: 0.65rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.04em; color: var(--text);
      line-height: 1.35; padding-right: 30px; min-height: 2.4em;
    }

    .card-total {
      font-family: var(--font-mono); font-size: 0.88rem;
      font-weight: 600; color: var(--yellow); margin: 5px 0 10px;
    }
    .card-total span { font-size: 0.55rem; font-weight: 400; color: var(--muted); }

    /* El grÃ¡fico es un poco mÃ¡s alto para que el punto rojo se vea bien */
    .chart-wrap { position: relative; height: 100px; }

    .trend {
      display: inline-block; margin-top: 7px;
      font-family: var(--font-mono); font-size: 0.55rem; padding: 2px 6px;
    }
    .trend.up   { background: rgba(224,60,49,.12); color: #f87171; }
    .trend.down { background: rgba(61,220,132,.1);  color: #3ddc84; }
    .trend.flat { background: rgba(122,139,168,.1); color: var(--muted); }

    /* Leyenda del punto pico */
    .peak-label {
      display: inline-flex; align-items: center; gap: 5px;
      font-family: var(--font-mono); font-size: 0.52rem;
      color: var(--muted); margin-top: 4px; margin-left: 6px;
    }
    .peak-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--red); flex-shrink: 0;
    }

    /* â”€â”€ SKELETONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .skel {
      height: 185px;
      background: linear-gradient(90deg, var(--card) 25%, #192236 50%, var(--card) 75%);
      background-size: 200%;
      animation: shimmer 1.4s infinite;
      border: 1px solid var(--border);
    }
    @keyframes shimmer { from{background-position:200% 0} to{background-position:-200% 0} }

    /* â”€â”€ ERROR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #error-box { display: none; padding: 60px 0; text-align: center; }
    #error-box h2 { font-family: var(--font-head); font-size: 1.5rem; margin-bottom: 10px; }
    #error-box p  { color: var(--muted); font-size: .88rem; max-width: 480px; margin: 0 auto; }
    #error-box code {
      display: block; margin: 18px auto; max-width: 600px;
      padding: 12px 16px; background: var(--card);
      border: 1px solid var(--border); font-family: var(--font-mono);
      font-size: 0.68rem; color: var(--accent);
      text-align: left; word-break: break-all; white-space: pre-wrap;
    }

    /* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      border-top: 1px solid var(--border);
      padding: 20px 32px; text-align: center;
      font-family: var(--font-mono); font-size: 0.65rem; color: var(--muted);
    }
    footer a { color: var(--accent); text-decoration: none; }
    footer a:hover { text-decoration: underline; }

    /* â”€â”€ MOBILE HEADER ADJUSTMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 600px) {
      header { padding: 40px 20px 24px; }
      main   { padding: 20px 16px 60px; }
      #status-bar { padding: 10px 20px; }
      .header-right { width: 100%; flex-direction: row; justify-content: space-between; align-items: center; }
    }
  </style>
</head>
<body>

<header>
  <div class="flag-stripe"></div>
  <div class="header-inner">
    <div>
      <h1>Delitos en <em>Colombia</em></h1>
      <p class="subtitle">VÃ­ctimas por categorÃ­a Â· EvoluciÃ³n anual Â· FiscalÃ­a General de la NaciÃ³n</p>
    </div>
    <div class="header-right">
      <button class="btn-refresh" id="btn-refresh" onclick="loadData(true)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
             stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 4v6h6M23 20v-6h-6"/>
          <path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/>
        </svg>
        Actualizar datos
      </button>
      <div class="last-updated" id="last-updated">Fuente: datos.gov.co Â· Socrata SODA 2.0</div>
      <div class="last-updated">Creado por <strong style="color: var(--text); font-weight: 600;">Ivan Felipe Agudelo</strong></div>
    </div>
  </div>
</header>

<div id="status-bar">
  <div class="dot loading" id="dot"></div>
  <span id="status-msg">Conectando con datos.gov.coâ€¦</span>
</div>

<main>
  <div id="summary">
    <div class="summary-cell"><div class="num" id="s-vic">â€”</div><div class="lbl">Total vÃ­ctimas</div></div>
    <div class="summary-cell"><div class="num" id="s-cat">â€”</div><div class="lbl">CategorÃ­as</div></div>
    <div class="summary-cell"><div class="num" id="s-years">â€”</div><div class="lbl">AÃ±os de datos</div></div>
    <div class="summary-cell"><div class="num" id="s-first">â€”</div><div class="lbl">Primer aÃ±o</div></div>
    <div class="summary-cell"><div class="num" id="s-last">â€”</div><div class="lbl">Ãšltimo aÃ±o completo</div></div>
  </div>

  <div class="section-title">
    <h2>EvoluciÃ³n anual por categorÃ­a Â· de mayor a menor Â· punto rojo = peak histÃ³rico</h2>
    <hr>
  </div>

  <div id="grid"></div>

  <div id="error-box">
    <h2>No se pudieron cargar los datos</h2>
    <p>Verifica tu conexiÃ³n a internet e intenta de nuevo.</p>
    <code id="error-detail"></code>
  </div>
</main>

<footer>
  Datos:
  <a href="https://www.datos.gov.co/Justicia-y-Derecho/Conteo-de-V-ctimas-V2/4mnf-va5w" target="_blank">Conteo de VÃ­ctimas V2</a>
  &nbsp;Â·&nbsp;
  Fuente: FiscalÃ­a General de la NaciÃ³n
  &nbsp;Â·&nbsp;
  <a href="https://www.datos.gov.co/resource/4mnf-va5w.json" target="_blank">API SODA 2.0</a>
</footer>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NOTA TÃ‰CNICA:
// El dataset solo tiene granularidad ANUAL (campo: a_o_hechos).
// No existe un campo de mes en la fuente de datos.
// Para evitar la caÃ­da visual del aÃ±o actual (incompleto), lo excluimos.
// El aÃ±o "Ãºltimo completo" es el aÃ±o anterior al actual.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ MODO ADMIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// El botÃ³n "Actualizar datos" solo aparece si la URL contiene ?admin=TUCLAVE
// Ejemplo: https://tu-sitio.vercel.app?admin=colombia2024
// Cambia "colombia2024" por la clave que tÃº quieras. Solo tÃº la conoces.
const ADMIN_KEY = 'colombia2024';
if (new URLSearchParams(window.location.search).get('admin') === ADMIN_KEY) {
  document.getElementById('btn-refresh').style.display = 'inline-flex';
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const RESOURCE   = 'https://www.datos.gov.co/resource/4mnf-va5w.json';
const THIS_YEAR  = new Date().getFullYear();
// Excluir el aÃ±o actual porque solo tiene datos parciales
const MAX_YEAR   = THIS_YEAR - 1;

function buildUrl(offset = 0) {
  const params = new URLSearchParams({
    '$select': 'grupo_delito, a_o_hechos, sum(total_victimas) as total',
    '$group':  'grupo_delito, a_o_hechos',
    '$order':  'a_o_hechos ASC',
    '$limit':  '50000',
    '$offset': String(offset),
  });
  return `${RESOURCE}?${params}`;
}

const CHARTS = {};
const $      = id => document.getElementById(id);
const fmt    = n =>
  n >= 1e6 ? (n/1e6).toFixed(1)+'M' :
  n >= 1e3 ? (n/1e3).toFixed(0)+'K' :
  n.toLocaleString('es-CO');

const setStatus = (state, msg) => {
  $('dot').className   = 'dot ' + state;
  $('status-msg').textContent = msg;
};

const setBtn = loading => {
  const b = $('btn-refresh');
  b.classList.toggle('spinning', loading);
  b.disabled = loading;
};

// â”€â”€ FETCH con paginaciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchAll() {
  let all = [], offset = 0;
  while (true) {
    const res   = await fetch(buildUrl(offset));
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    const batch = await res.json();
    if (!Array.isArray(batch) || !batch.length) break;
    all = all.concat(batch);
    setStatus('loading', `Descargandoâ€¦ ${all.length.toLocaleString()} registros`);
    if (batch.length < 50000) break;
    offset += 50000;
  }
  return all;
}

// â”€â”€ PROCESAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMap(rows) {
  const map = {};
  for (const r of rows) {
    const g = (r.grupo_delito || 'SIN CLASIFICAR').trim();
    const y = parseInt(r.a_o_hechos);
    const v = parseFloat(r.total) || 0;

    // Solo aÃ±os vÃ¡lidos y hasta el Ãºltimo aÃ±o completo
    if (!y || isNaN(y) || y < 2000 || y > MAX_YEAR) continue;

    if (!map[g]) map[g] = {};
    map[g][y] = (map[g][y] || 0) + v;
  }
  return map;
}

function sortGroups(map) {
  return Object.entries(map)
    .map(([name, byYear]) => ({
      name,
      byYear,
      total: Object.values(byYear).reduce((a, b) => a + b, 0),
    }))
    .filter(d => d.total > 0)
    .sort((a, b) => b.total - a.total);
}

// â”€â”€ TENDENCIA: Ãºltimo vs penÃºltimo aÃ±o disponible â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcTrend(byYear) {
  const yrs = Object.keys(byYear).map(Number).sort((a, b) => a - b);
  if (yrs.length < 2) return 0;
  const last = byYear[yrs.at(-1)];
  const prev = byYear[yrs.at(-2)];
  return prev ? ((last - prev) / prev) * 100 : 0;
}

// â”€â”€ RESUMEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSummary(groups) {
  const totalVic  = groups.reduce((a, b) => a + b.total, 0);
  const allYears  = [...new Set(
    groups.flatMap(g => Object.keys(g.byYear).map(Number))
  )].sort((a, b) => a - b);

  $('s-vic').textContent   = fmt(totalVic);
  $('s-cat').textContent   = groups.length;
  $('s-years').textContent = allYears.length;
  $('s-first').textContent = allYears.at(0)  || 'â€”';
  $('s-last').textContent  = allYears.at(-1) || 'â€”';
  $('summary').style.display = 'grid';
}

// â”€â”€ GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGrid(groups) {
  const grid = $('grid');
  grid.innerHTML = '';

  groups.forEach((g, i) => {
    const years   = Object.keys(g.byYear).map(Number).sort((a, b) => a - b);
    const values  = years.map(y => g.byYear[y]);
    const peakIdx = values.indexOf(Math.max(...values));
    const peakYear = years[peakIdx];
    const t       = calcTrend(g.byYear);
    const cid     = `ch${i}`;

    const tClass = t > 5 ? 'up' : t < -5 ? 'down' : 'flat';
    const tLabel = t > 5
      ? `â–² +${t.toFixed(0)}% Ãºltimo aÃ±o`
      : t < -5
        ? `â–¼ ${t.toFixed(0)}% Ãºltimo aÃ±o`
        : 'â€” estable';

    const card = document.createElement('div');
    card.className = 'card';
    card.style.animationDelay = `${(i % 4) * 0.05}s`;
    card.innerHTML = `
      <span class="card-rank">#${i + 1}</span>
      <div class="card-name">${g.name}</div>
      <div class="card-total">${fmt(g.total)} <span>vÃ­ctimas totales</span></div>
      <div class="chart-wrap"><canvas id="${cid}"></canvas></div>
      <span class="trend ${tClass}">${tLabel}</span>
      <span class="peak-label">
        <span class="peak-dot"></span>peak ${peakYear}: ${fmt(values[peakIdx])}
      </span>
    `;
    grid.appendChild(card);
    requestAnimationFrame(() => drawChart(cid, years, values, peakIdx, t));
  });
}

// â”€â”€ CHART con punto rojo en el peak â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawChart(id, years, values, peakIdx, t) {
  if (CHARTS[id]) { CHARTS[id].destroy(); delete CHARTS[id]; }
  const el = $(id);
  if (!el) return;
  const ctx = el.getContext('2d');

  // Color de la lÃ­nea segÃºn tendencia
  const lineColor = t > 5 ? '#f87171' : t < -5 ? '#3ddc84' : '#4f9cf9';

  // Degradado de relleno
  const grad = ctx.createLinearGradient(0, 0, 0, 100);
  grad.addColorStop(0, lineColor + '22');
  grad.addColorStop(1, lineColor + '00');

  // Arrays punto a punto:
  // - Todos los puntos son invisibles (radius 0)
  // - Excepto el peak: punto rojo de radius 5
  const pointRadius = values.map((_, i) => i === peakIdx ? 5 : 0);
  const pointColors = values.map((_, i) => i === peakIdx ? '#e03c31' : lineColor);
  const pointBorder = values.map((_, i) => i === peakIdx ? '#ff6b6b' : lineColor);
  const pointHover  = values.map((_, i) => i === peakIdx ? 7 : 3);

  CHARTS[id] = new Chart(ctx, {
    type: 'line',
    data: {
      labels: years,
      datasets: [{
        data: values,
        borderColor: lineColor,
        borderWidth: 1.5,
        backgroundColor: grad,
        fill: true,
        tension: 0.35,
        // Puntos individuales por Ã­ndice
        pointRadius:          pointRadius,
        pointHoverRadius:     pointHover,
        pointBackgroundColor: pointColors,
        pointBorderColor:     pointBorder,
        pointBorderWidth:     2,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 500 },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a2540',
          titleColor: '#7a8ba8',
          bodyColor: '#e8ecf4',
          bodyFont:  { family: 'JetBrains Mono', size: 11 },
          titleFont: { family: 'JetBrains Mono', size: 10 },
          callbacks: {
            label: c => {
              const isPeak = c.dataIndex === peakIdx;
              return ` ${c.parsed.y.toLocaleString('es-CO')} vÃ­ctimas${isPeak ? ' ðŸ”´ PEAK' : ''}`;
            },
          },
        },
      },
      scales: {
        x: {
          grid: { color: '#1a2540', lineWidth: 0.5 },
          ticks: {
            color: '#7a8ba8',
            font: { family: 'JetBrains Mono', size: 8 },
            maxTicksLimit: 6,
            maxRotation: 0,
          },
        },
        y: {
          grid: { color: '#1a2540', lineWidth: 0.5 },
          ticks: {
            color: '#7a8ba8',
            font: { family: 'JetBrains Mono', size: 8 },
            maxTicksLimit: 4,
            callback: v => v >= 1000 ? (v/1000).toFixed(0)+'K' : v,
          },
          beginAtZero: false,
        },
      },
    },
  });
}

// â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData(force = false) {
  const grid     = $('grid');
  const errorBox = $('error-box');

  setBtn(true);
  setStatus('loading', 'Conectando con datos.gov.coâ€¦');
  errorBox.style.display   = 'none';
  $('summary').style.display = 'none';

  // Skeletons mientras carga
  grid.innerHTML = '';
  for (let i = 0; i < 8; i++) {
    const sk = document.createElement('div');
    sk.className = 'skel';
    grid.appendChild(sk);
  }

  try {
    const rows = await fetchAll();
    if (!rows.length) throw new Error('El API devolviÃ³ 0 registros');

    setStatus('loading', `Procesando ${rows.length.toLocaleString()} registrosâ€¦`);
    const map    = buildMap(rows);
    const groups = sortGroups(map);
    if (!groups.length) throw new Error('No se encontraron categorÃ­as vÃ¡lidas');

    renderSummary(groups);
    grid.innerHTML = '';
    renderGrid(groups);

    const now = new Date().toLocaleString('es-CO', { dateStyle: 'long', timeStyle: 'short' });
    setStatus('ok', `${rows.length.toLocaleString()} registros Â· ${groups.length} categorÃ­as Â· datos hasta ${MAX_YEAR}`);
    $('last-updated').textContent = `Actualizado: ${now} Â· aÃ±os 2000â€“${MAX_YEAR}`;

  } catch (err) {
    console.error(err);
    grid.innerHTML = '';
    setStatus('error', 'Error al cargar datos');
    errorBox.style.display = 'block';
    $('error-detail').textContent = `Error: ${err.message}\n\nURL: ${buildUrl(0)}`;
  } finally {
    setBtn(false);
  }
}

loadData();
</script>
</body>
</html>
